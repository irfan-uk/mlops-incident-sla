name: Incident SLA MLOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  # Job 1: Data Validation and Testing
  test:
    name: Data Validation & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run data validation tests
      run: |
        echo "Running data validation..."
        python -c "
        import pandas as pd
        import os
        
        # Check if data exists
        assert os.path.exists('data/sla_breach_prediction_dataset.csv'), 'Dataset not found'
        
        # Load and validate
        df = pd.read_csv('data/sla_breach_prediction_dataset.csv')
        
        # Required columns
        required_cols = ['reassignment_count', 'reopen_count', 'sys_mod_count',
                        'open_hour', 'is_business_hours', 'workload_score', 'sla_breach']
        
        for col in required_cols:
            assert col in df.columns, f'Missing column: {col}'
        
        # Check target variable
        assert 'sla_breach' in df.columns, 'Target variable not found'
        assert df['sla_breach'].isin([0, 1]).all(), 'Invalid target values'
        
        # Check data quality
        breach_rate = df['sla_breach'].mean()
        assert 0.01 < breach_rate < 0.5, f'Unusual breach rate: {breach_rate}'
        
        print('✅ All data validation tests passed!')
        print(f'Dataset shape: {df.shape}')
        print(f'SLA breach rate: {breach_rate:.2%}')
        "
    
    - name: Check model file structure
      run: |
        mkdir -p models
        echo "✅ Models directory created"

  # Job 2: Model Training
  train:
    name: Train ML Models
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Train models
      run: |
        echo "Training models with MLflow..."
        python train.py
    
    - name: Validate model artifacts
      run: |
        python -c "
        import os
        import joblib
        
        # Check if models were created
        assert os.path.exists('models/best_model.pkl'), 'Best model not found'
        assert os.path.exists('models/model_rf_v1.pkl'), 'RF model not found'
        assert os.path.exists('models/model_xgb_v2.pkl'), 'XGB model not found'
        
        # Try loading the model
        model = joblib.load('models/best_model.pkl')
        print(f'✅ Model loaded successfully: {type(model).__name__}')
        
        # Check model has required methods
        assert hasattr(model, 'predict'), 'Model missing predict method'
        assert hasattr(model, 'predict_proba'), 'Model missing predict_proba method'
        
        print('✅ All model validation tests passed!')
        "
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-models
        path: models/
        retention-days: 30

  # Job 3: API Testing
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: train
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Test API endpoints
      run: |
        # Start API in background
        python app.py &
        API_PID=$!
        
        # Wait for API to start
        sleep 10
        
        # Test health endpoint
        echo "Testing /health endpoint..."
        curl -f http://localhost:8000/health || exit 1
        echo "✅ Health check passed"
        
        # Test prediction endpoint
        echo "Testing /predict endpoint..."
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{
            "reassignment_count": 2,
            "reopen_count": 0,
            "sys_mod_count": 8,
            "open_hour": 15,
            "open_day": 2,
            "open_month": 11,
            "is_business_hours": 1,
            "is_weekday": 1,
            "workload_score": 2.8,
            "complexity_flag": 0,
            "reassigned": 1,
            "reopened": 0,
            "incident_state_code": 1,
            "active": 1
          }' || exit 1
        echo "✅ Prediction test passed"
        
        # Test model-info endpoint
        echo "Testing /model-info endpoint..."
        curl -f http://localhost:8000/model-info || exit 1
        echo "✅ Model info test passed"
        
        # Kill API process
        kill $API_PID
        
        echo "✅ All API tests passed!"

  # Job 4: Build Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: api-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: mlops-incident-sla:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        docker run -d -p 8000:8000 --name test-api mlops-incident-sla:latest
        sleep 10
        curl -f http://localhost:8000/health || exit 1
        docker stop test-api
        docker rm test-api
        echo "✅ Docker image test passed!"

  # Job 5: Deploy to Azure (manual trigger or on main branch)
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure Container Instances
      run: |
        echo "Deploying to Azure..."
        # Add your Azure deployment commands here
        # Example:
        # az container create \
        #   --resource-group mlops-rg \
        #   --name mlops-incident-api \
        #   --image your-registry/mlops-incident-sla:latest \
        #   --cpu 1 --memory 1 \
        #   --ports 8000
    
    - name: Deployment notification
      run: |
        echo "✅ Deployment complete!"
        echo "API endpoint: https://your-azure-url.com"