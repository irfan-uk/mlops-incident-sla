name: Incident SLA MLOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  AZURE_RESOURCE_GROUP: 'sla-rg'
  AZURE_LOCATION: 'eastus'
  CONTAINER_NAME: 'incident-sla-api'

jobs:
  # Job 1: Data Validation and Testing
  test:
    name: Data Validation & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run data validation tests
      run: |
        echo "Running data validation..."
        python -c "
        import pandas as pd
        import os
        
        # Check if data exists
        assert os.path.exists('data/sla_breach_prediction_dataset.csv'), 'Dataset not found'
        
        # Load and validate
        df = pd.read_csv('data/sla_breach_prediction_dataset.csv')
        
        # Required columns
        required_cols = ['reassignment_count', 'reopen_count', 'sys_mod_count',
                        'open_hour', 'is_business_hours', 'workload_score', 'sla_breach']
        
        for col in required_cols:
            assert col in df.columns, f'Missing column: {col}'
        
        # Check target variable
        assert 'sla_breach' in df.columns, 'Target variable not found'
        assert df['sla_breach'].isin([0, 1]).all(), 'Invalid target values'
        
        # Check data quality
        breach_rate = df['sla_breach'].mean()
        assert 0.01 < breach_rate < 0.5, f'Unusual breach rate: {breach_rate}'
        
        print('âœ… All data validation tests passed!')
        print(f'Dataset shape: {df.shape}')
        print(f'SLA breach rate: {breach_rate:.2%}')
        "
    
    - name: Check model file structure
      run: |
        mkdir -p models
        echo "âœ… Models directory created"

  # Job 2: Model Training
  train:
    name: Train ML Models
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Train models
      run: |
        echo "Training models with MLflow..."
        export MLFLOW_TRACKING_URI=./mlruns
        python train.py
    
    - name: Validate model artifacts
      run: |
        python -c "
        import os
        import joblib
        
        # Check if models were created
        assert os.path.exists('models/best_model.pkl'), 'Best model not found'
        assert os.path.exists('models/model_rf_v1.pkl'), 'RF model not found'
        assert os.path.exists('models/model_xgb_v2.pkl'), 'XGB model not found'
        
        # Try loading the model
        model = joblib.load('models/best_model.pkl')
        print(f'âœ… Model loaded successfully: {type(model).__name__}')
        
        # Check model has required methods
        assert hasattr(model, 'predict'), 'Model missing predict method'
        assert hasattr(model, 'predict_proba'), 'Model missing predict_proba method'
        
        print('âœ… All model validation tests passed!')
        "
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: models/
        retention-days: 30

  # Job 3: API Testing
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: train
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: Test API endpoints
      run: |
        # Start API in background
        python app.py &
        API_PID=$!
        
        # Wait for API to start
        sleep 10
        
        # Test health endpoint
        echo "Testing /health endpoint..."
        curl -f http://localhost:8000/health || exit 1
        echo "âœ… Health check passed"
        
        # Test prediction endpoint
        echo "Testing /predict endpoint..."
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{
            "reassignment_count": 2,
            "reopen_count": 0,
            "sys_mod_count": 8,
            "open_hour": 15,
            "open_day": 2,
            "open_month": 11,
            "is_business_hours": 1,
            "is_weekday": 1,
            "workload_score": 2.8,
            "complexity_flag": 0,
            "reassigned": 1,
            "reopened": 0,
            "incident_state_code": 1,
            "active": 1
          }' || exit 1
        echo "âœ… Prediction test passed"
        
        # Test model-info endpoint
        echo "Testing /model-info endpoint..."
        curl -f http://localhost:8000/model-info || exit 1
        echo "âœ… Model info test passed"
        
        # Kill API process
        kill $API_PID
        
        echo "âœ… All API tests passed!"

  # Job 4: Build Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: api-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: mlops-incident-sla:latest
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        docker run -d -p 8000:8000 --name test-api mlops-incident-sla:latest
        sleep 10
        curl -f http://localhost:8000/health || exit 1
        docker stop test-api
        docker rm test-api
        echo "âœ… Docker image test passed!"
    
    - name: Save Docker image as artifact
      run: |
        docker save mlops-incident-sla:latest | gzip > mlops-incident-sla.tar.gz
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: mlops-incident-sla.tar.gz
        retention-days: 1

  # Job 5: Deploy to Azure Container Instances
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Load and push Docker image to ACR
      run: |
        # Create ACR if it doesn't exist
        az acr create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name irfansla \
          --sku Basic \
          --admin-enabled true \
          || echo "ACR already exists"
        
        # Get ACR credentials
        ACR_USERNAME=$(az acr credential show --name irfansla --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name irfansla --query passwords[0].value -o tsv)
        
        # Login to ACR
        echo $ACR_PASSWORD | docker login irfansla.azurecr.io -u $ACR_USERNAME --password-stdin
        
        # Load Docker image
        docker load -i mlops-incident-sla.tar.gz
        
        # Tag and push to ACR
        docker tag mlops-incident-sla:latest irfansla.azurecr.io/incident-sla-api:${{ github.run_number }}
        docker tag mlops-incident-sla:latest irfansla.azurecr.io/incident-sla-api:latest
        docker push irfansla.azurecr.io/incident-sla-api:${{ github.run_number }}
        docker push irfansla.azurecr.io/incident-sla-api:latest
        
        echo "âœ… Image pushed to ACR"
    
    - name: Deploy to Azure Container Instances
      run: |
        # Get ACR credentials
        ACR_USERNAME=$(az acr credential show --name irfansla --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name irfansla --query passwords[0].value -o tsv)
        
        # Delete existing container if exists
        az container delete \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --yes \
          || echo "No existing container to delete"
        
        # Deploy new container
        az container create \
        --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
        --name ${{ env.CONTAINER_NAME }} \
        --image irfansla.azurecr.io/incident-sla-api:latest \
        --registry-login-server irfansla.azurecr.io \
        --registry-username $ACR_USERNAME \
        --registry-password $ACR_PASSWORD \
        --dns-name-label incident-sla-api-${{ github.run_number }} \
        --ports 8000 \
        --cpu 1 \
        --memory 2 \
        --environment-variables ENVIRONMENT=production \
        --restart-policy Always \
        --location ${{ env.AZURE_LOCATION }} \
        --os-type Linux

        
        echo "âœ… Container deployed to Azure"
    
    - name: Get deployment URL and test
      run: |
        # Wait for deployment
        sleep 30
        
        # Get FQDN
        FQDN=$(az container show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --query ipAddress.fqdn -o tsv)
        
        API_URL="http://${FQDN}:8000"
        
        echo "======================================"
        echo "âœ… DEPLOYMENT SUCCESSFUL!"
        echo "======================================"
        echo "API URL: ${API_URL}"
        echo "Health: ${API_URL}/health"
        echo "Docs: ${API_URL}/docs"
        echo "======================================"
        
        # Test health endpoint
        echo "Testing health endpoint..."
        for i in {1..5}; do
          if curl -f ${API_URL}/health; then
            echo "âœ… API is responding!"
            break
          else
            echo "Waiting for API... (attempt $i/5)"
            sleep 10
          fi
        done
        
        # Save URL
        echo "${API_URL}" > deployment_url.txt
    
    - name: Upload deployment URL
      uses: actions/upload-artifact@v4
      with:
        name: deployment-url
        path: deployment_url.txt
    
    - name: Create deployment summary
      run: |
        FQDN=$(az container show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --query ipAddress.fqdn -o tsv)
        
        echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ API Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- **Base URL**: http://${FQDN}:8000" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: http://${FQDN}:8000/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Interactive Docs**: http://${FQDN}:8000/docs" >> $GITHUB_STEP_SUMMARY
        echo "- **Predict Endpoint**: http://${FQDN}:8000/predict" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª Test Commands" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Health check" >> $GITHUB_STEP_SUMMARY
        echo "curl http://${FQDN}:8000/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Make prediction" >> $GITHUB_STEP_SUMMARY
        echo "curl -X POST http://${FQDN}:8000/predict \\" >> $GITHUB_STEP_SUMMARY
        echo '  -H "Content-Type: application/json" \' >> $GITHUB_STEP_SUMMARY
        echo '  -d '"'"'{"reassignment_count":2,"reopen_count":0,"sys_mod_count":8,"open_hour":15,"open_day":2,"open_month":11,"is_business_hours":1,"is_weekday":1,"workload_score":2.8,"complexity_flag":0,"reassigned":1,"reopened":0,"incident_state_code":1,"active":1}'"'"'' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container Name**: ${{ env.CONTAINER_NAME }}" >> $GITHUB_STEP_SUMMARY